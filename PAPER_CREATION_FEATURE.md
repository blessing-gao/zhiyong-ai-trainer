# 试卷管理 - 新增试卷功能

## 📋 功能概述

在管理员模块的试卷管理页面中，新增了"新增试卷"按钮，点击后弹出对话框，允许管理员输入试卷参数并进行自动组卷。

## 🎯 功能特性

### 1. 新增试卷按钮
- 位置：试卷管理页面右上角
- 样式：蓝色按钮，带Plus图标
- 功能：点击打开新增试卷对话框

### 2. 新增试卷对话框
包含以下功能模块：

#### 试卷基本信息
- **试卷名称** (必填)
  - 输入框，支持任意文本
  - 验证：不能为空

- **试卷类型** (必填)
  - 下拉选择：正式考试卷、练习卷、模拟卷
  - 默认值：正式考试卷

- **试卷说明** (可选)
  - 文本域，支持多行输入
  - 用于描述试卷的用途和说明

- **试卷总分** (必填)
  - 数字输入框
  - 默认值：150
  - 验证：必须大于0

- **及格分数** (必填)
  - 数字输入框
  - 默认值：90
  - 验证：必须大于0，不能大于试卷总分

- **考试时长** (必填)
  - 数字输入框，单位：分钟
  - 默认值：120
  - 验证：必须大于0

- **题目总数** (必填)
  - 数字输入框
  - 默认值：100
  - 验证：必须大于0

#### 题型比例配置
- **判断题比例** (%)
  - 默认值：20
  - 范围：0-100

- **单选题比例** (%)
  - 默认值：70
  - 范围：0-100

- **多选题比例** (%)
  - 默认值：10
  - 范围：0-100

- **实时显示比例总和**
  - 验证：必须等于100%

#### 知识点比例配置
- 自动加载所有一级知识点
- 为每个知识点设置比例 (%)
- 默认均匀分配 (100 / 知识点数量)
- 最后一个知识点自动补足余数
- 实时显示比例总和
- 验证：必须等于100%

### 3. 表单验证

#### 验证规则
1. 试卷名称不能为空
2. 试卷总分必须大于0
3. 及格分数必须大于0
4. 及格分数不能大于试卷总分
5. 考试时长必须大于0
6. 题目总数必须大于0
7. 题型比例之和必须等于100
8. 知识点比例之和必须等于100

#### 错误提示
- 验证失败时，在对话框顶部显示红色错误提示
- 错误信息清晰指出问题所在

### 4. 创建试卷流程

1. **用户输入参数**
   - 填写试卷基本信息
   - 配置题型比例
   - 配置知识点比例

2. **前端验证**
   - 验证所有必填字段
   - 验证比例之和
   - 显示验证错误

3. **调用后端API**
   - 发送POST请求到 `/api/papers`
   - 传递完整的CreatePaperRequest对象

4. **后端组卷**
   - 后端执行自动组卷算法
   - 按题型比例分配题目
   - 按知识点比例选题
   - 自动补足不足的题目

5. **返回结果**
   - 后端返回完整的Paper对象
   - 包含生成的题目ID列表

6. **刷新列表**
   - 关闭对话框
   - 刷新试卷列表
   - 新创建的试卷出现在列表中

## 📊 API集成

### 创建试卷API

**端点**: `POST /api/papers`

**请求体**:
```typescript
{
  name: string;              // 试卷名称
  description?: string;      // 试卷说明
  type: 'exam' | 'practice' | 'mock';  // 试卷类型
  totalScore: number;        // 试卷总分
  passScore: number;         // 及格分数
  duration: number;          // 考试时长(分钟)
  questionCount: number;     // 题目总数
  typeRatio: {
    judge: number;           // 判断题比例
    single: number;          // 单选题比例
    multiple: number;        // 多选题比例
  };
  knowledgeRatio: {
    [tagId: number]: number; // 知识点ID -> 比例
  };
}
```

**响应**:
```typescript
{
  code: 0;
  message: 'success';
  data: {
    id: number;
    name: string;
    questionCount: number;
    status: number;
    // ... 其他字段
  };
}
```

### 获取一级知识点API

**端点**: `GET /api/tags/first-level`

**响应**:
```typescript
{
  code: 0;
  message: 'success';
  data: [
    { id: 1, tagName: '知识点1' },
    { id: 2, tagName: '知识点2' },
    // ...
  ];
}
```

## 🎨 UI/UX设计

### 对话框样式
- 固定宽度：最大800px
- 最大高度：90vh，超出时滚动
- 半透明背景：黑色50%透明度
- 圆角卡片设计

### 表单布局
- 两列网格布局（大屏幕）
- 响应式设计（小屏幕自动调整）
- 清晰的分组和标题
- 实时验证反馈

### 交互反馈
- 加载状态：显示加载动画
- 创建中：按钮显示"创建中..."
- 错误提示：红色背景，清晰的错误信息
- 成功：自动关闭对话框，刷新列表

## 🔧 技术实现

### 前端组件
- **PaperManagement.tsx**: 主组件
  - 管理试卷列表
  - 管理创建对话框状态
  - 处理表单验证
  - 调用API

### 状态管理
```typescript
// 创建对话框状态
showCreateDialog: boolean;
firstLevelTags: FirstLevelTag[];
tagsLoading: boolean;
creating: boolean;
createError: string | null;

// 表单数据
formData: CreatePaperFormData;
```

### 关键函数
- `handleOpenCreateDialog()`: 打开对话框，加载知识点
- `handleCloseCreateDialog()`: 关闭对话框，重置表单
- `validateForm()`: 验证表单数据
- `handleCreatePaper()`: 创建试卷，调用API
- `loadFirstLevelTags()`: 加载一级知识点

## 📱 使用流程

### 步骤1：打开对话框
1. 点击"新增试卷"按钮
2. 对话框打开，自动加载知识点
3. 表单显示默认值

### 步骤2：填写基本信息
1. 输入试卷名称
2. 选择试卷类型
3. 输入试卷说明（可选）
4. 输入试卷总分、及格分数
5. 输入考试时长、题目总数

### 步骤3：配置题型比例
1. 调整判断题、单选题、多选题的比例
2. 实时查看比例总和
3. 确保比例总和为100%

### 步骤4：配置知识点比例
1. 查看所有一级知识点
2. 调整各知识点的比例
3. 实时查看比例总和
4. 确保比例总和为100%

### 步骤5：创建试卷
1. 点击"创建试卷"按钮
2. 前端验证表单数据
3. 调用后端API
4. 等待组卷完成
5. 对话框自动关闭
6. 试卷列表自动刷新

## ✅ 验证清单

- [x] 新增试卷按钮已实现
- [x] 创建试卷对话框已实现
- [x] 表单验证已实现
- [x] API集成已完成
- [x] 知识点自动加载已实现
- [x] 比例实时计算已实现
- [x] 错误提示已实现
- [x] 加载状态已实现
- [x] 前端编译成功

## 🚀 后续优化

### 短期优化
- [ ] 添加表单预设模板
- [ ] 支持快速设置常用配置
- [ ] 添加更多验证提示

### 中期优化
- [ ] 支持试卷预览
- [ ] 支持试卷编辑
- [ ] 支持批量创建

### 长期优化
- [ ] 支持自定义题型
- [ ] 支持高级选题规则
- [ ] 支持组卷历史记录

## 📝 相关文档

- [后端创建试卷API文档](../zhiyong-backend/doc/PAPER_GENERATION_API.md)
- [前端集成指南](./PAPER_CREATION_GUIDE.md)
- [试卷管理模块设计](../zhiyong-backend/doc/PAPER_DOMAIN_DESIGN.md)

## 🎓 开发者指南

### 修改表单字段
编辑 `PaperManagement.tsx` 中的 `CreatePaperFormData` 接口和表单UI

### 修改验证规则
编辑 `validateForm()` 函数

### 修改API端点
编辑 `src/services/api.ts` 中的 `paperApi.createPaper()`

### 修改样式
编辑对话框的Tailwind CSS类名

---

**功能完成时间**: 2025-10-18  
**版本**: 1.0  
**状态**: ✅ 完成

